name: "release-please"

on:
  push:
    branches:
      - "rc"
      - "maintenance/*"

concurrency:
  group: "${{ github.workflow }}-${{ github.ref }}"

jobs:
  release-please:
    runs-on: ubuntu-latest

    outputs:
      release-created: ${{ steps.release.outputs.release_created }}
      pr: ${{ steps.release.outputs['pr'] }}
      tag-name: ${{ steps.release.outputs['tag_name'] }}
      version: ${{ steps.release.outputs['version'] }}

    steps:
      - name: Run release-please
        id: release
        uses: googleapis/release-please-action@v4
        with:
          target-branch: ${{ github.ref_name }}
          config-file: ${{ github.ref_name == 'rc'
            && '.github/release-please/config.json'
            || '.github/release-please/backport/config.json' }}
          manifest-file: ${{ github.ref_name == 'rc'
            && '.github/release-please/manifest.json'
            || '.github/release-please/backport/manifest.json' }}

      - name: Show output from release-please
        if: steps.release.outputs.release_created
        env:
          RELEASE_PLEASE_OUTPUT: ${{ toJSON(steps.release.outputs) }}
        run: echo "${RELEASE_PLEASE_OUTPUT}" | jq

  sync-release:
    needs: release-please
    if: needs.release-please.outputs.release-created
    runs-on: ubuntu-latest
    steps:
      - name: Checkout target branch
        uses: actions/checkout@v4
        with:
          ref: main
          fetch-depth: 0

      - name: Fast-forward main to release tag
        run: |
          git fetch --no-tags origin "refs/tags/${{ needs.release-please.outputs.tag-name }}"

          if git merge-base --is-ancestor HEAD FETCH_HEAD; then
            echo "Fast-forward merge possible."
          else
            echo "Error: main has commits not in the release tag; cannot fast-forward."
            exit 1
          fi

          git merge --ff-only FETCH_HEAD
          git push origin HEAD:main
